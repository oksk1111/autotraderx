# 가상화폐 자동 매매 기획 v4.0

---

# 📊 업비트 오픈 API 기반 3-Layer 통합 자동 매매 시스템

## 1. 개정 이력

| 버전 | 날짜 | 주요 변경사항 |
|------|------|--------------|
| v1.0 | 2024-11 | 초기 기획 - ML 단독 전략 |
| v2.0 | 2024-12-03 | 긴급 거래 모드 추가 |
| v3.0 | 2024-12-05 | 신호 필터링 v3.0, 자동 재훈련 시스템 |
| **v4.0** | **2024-12-06** | **3-Layer 통합 전략으로 전면 개편** |

---

## 2. 시스템 개요

### 2.1 개정 배경

#### ❌ 기존 시스템 문제점 (v3.0)
```
문제 1: 데이터 주기 불일치
- 기획: 1-5초 Tick 데이터 분석 (워뇨띠 스타일)
- 현실: 5분마다 1시간봉 분석
- 결과: 60-300배 느린 반응 → 단타 불가능

문제 2: ML 모델 한계
- 훈련 정확도: 85%
- 실전 신뢰도: 1-33% (평균 10%)
- 현상: 50% 미만 신뢰도 = 거래 안 함 → 21시간 거래 중단

문제 3: 수익률 저조
- 12월 5일: -7.3% 손실
- 원인: 모델 노후화 (2주) + 느린 반응 속도
```

#### ✅ v4.0 해결 방안
```
해결 1: 3-Layer 통합 전략
- Layer 1: 기술적 지표 (1초 반응)
- Layer 2: 멀티 타임프레임 (트렌드 확인)
- Layer 3: 강화학습 (선택적, 최적화)

해결 2: 거래 주기 단축
- 기존: 5분 → 개선: 1분
- 효과: 5배 더 많은 거래 기회

해결 3: 자동 재훈련 시스템
- 매일 새벽 3시 자동 모델 업데이트
- 최신 데이터로 지속 학습
```

---

## 3. 3-Layer 통합 전략

### 3.1 전략 구조

```
┌─────────────────────────────────────────────────┐
│          통합 트레이딩 엔진                        │
│         (Ensemble Decision Making)              │
└─────────────────────────────────────────────────┘
                      │
        ┌─────────────┼─────────────┐
        │             │             │
   ┌────▼─────┐  ┌───▼────┐  ┌────▼──────┐
   │ Layer 1  │  │Layer 2 │  │ Layer 3   │
   │ Hybrid   │  │MultiTF │  │ RL Agent  │
   │ (빠름)    │  │(안정)   │  │(최적화)    │
   └──────────┘  └────────┘  └───────────┘
        │             │             │
   ┌────▼─────┐  ┌───▼────┐  ┌────▼──────┐
   │ RSI      │  │ 1h 트렌드│  │DQN/PPO   │
   │ MACD     │  │15m 모멘텀│  │학습 에이전트│
   │ Volume   │  │ 5m 진입 │  │수익 최대화 │
   │Bollinger │  │         │  │           │
   └──────────┘  └────────┘  └───────────┘

        가중치 투표 (Weighted Voting)
    Layer 1: 30% | Layer 2: 30% | Layer 3: 40%
```

### 3.2 Layer 1: 하이브리드 전략 (Hybrid Engine)

#### 📌 목적
- **즉각 반응**: 1초 이내 매매 판단
- **워뇨띠 스타일**: 단기 패턴 포착

#### 🔧 구현
```python
# backend/app/trading/hybrid_engine.py

class HybridTradingEngine:
    """기술적 지표 중심, ML은 보조"""
    
    def analyze(self, market, df):
        # 1. 빠른 기술적 지표 분석
        signals = 0
        
        if rsi < 30:              # 과매도
            signals += 1
        if macd_cross == 'golden': # 골든크로스
            signals += 1
        if volume > 2x_average:    # 거래량 급등
            signals += 1
        if bb_position < 0.2:      # 볼린저 하단
            signals += 1
        
        # 2. 신호 강도에 따른 신뢰도
        if signals >= 3:
            return "BUY", 0.85  # 매우 강한 신호
        elif signals >= 2:
            return "BUY", 0.65  # 중간 신호
        
        # 3. ML 보조 검증
        ml_signal, ml_conf = ml_predictor.predict(market)
        if ml_signal == "SELL" and ml_conf > 0.7:
            confidence *= 0.6  # ML 반대 의견
        
        return action, confidence
```

#### 📊 성능 예상
```
반응 속도: 1초
정확도: 70-80%
예상 수익률: +5-10% (주간)
```

---

### 3.3 Layer 2: 멀티 타임프레임 전략 (Multi-Timeframe)

#### 📌 목적
- **트렌드 확인**: 큰 흐름 속에서 진입
- **리스크 감소**: 역추세 거래 방지

#### 🔧 구현
```python
# backend/app/trading/multi_timeframe_engine.py

class MultiTimeframeEngine:
    """장기 트렌드 + 단기 타이밍"""
    
    def analyze(self, market):
        # 1시간봉: 전체 트렌드
        trend_1h = analyze_trend(df_1h)  # UP/DOWN/SIDEWAYS
        
        # 15분봉: 모멘텀 강도
        momentum_15m = analyze_momentum(df_15m)  # STRONG/WEAK
        
        # 5분봉: 진입 타이밍
        entry_5m = analyze_entry(df_5m)  # BUY/SELL/HOLD
        
        # 조합 로직
        if trend_1h == "UP":
            if momentum_15m == "STRONG" and entry_5m == "BUY":
                return "BUY", 0.90  # 완벽한 타이밍
            elif entry_5m == "BUY":
                return "BUY", 0.70  # 괜찮은 타이밍
        
        elif trend_1h == "DOWN":
            return "HOLD", 0.20  # 하락장 거래 자제
        
        return "HOLD", 0.35
```

#### 📊 성능 예상
```
반응 속도: 1-5분
정확도: 80-90%
예상 수익률: +10-15% (주간)
리스크 감소: -50%
```

---

### 3.4 Layer 3: 강화학습 전략 (Reinforcement Learning) - 선택적

#### 📌 목적
- **수익 최대화**: 직접 학습으로 최적 전략 탐색
- **실시간 적응**: 시장 변화에 동적 대응

#### 🔧 구현 (향후)
```python
# backend/app/ml/rl_agent.py

class RLTradingAgent:
    """DQN/PPO 기반 강화학습"""
    
    def train(self):
        # 환경: 실제 시장 시뮬레이션
        # 상태: 가격, 지표, 보유량
        # 행동: BUY, SELL, HOLD
        # 보상: 수익 - 비용 - 리스크
        
        for episode in range(10000):
            state = env.reset()
            while not done:
                action = agent.select_action(state)
                next_state, reward, done = env.step(action)
                agent.learn(state, action, reward, next_state)
    
    def predict(self, state):
        # 학습된 정책으로 최적 행동 선택
        action = agent.act(state)
        return action, confidence
```

#### 📊 성능 예상
```
반응 속도: 실시간
정확도: 90%+
예상 수익률: +15-20% (주간)
단점: 구현 복잡도 높음 (1-2주 소요)
```

---

## 4. 통합 엔진 (Ensemble Decision Making)

### 4.1 가중치 투표 시스템

```python
# backend/app/trading/integrated_engine.py

class IntegratedTradingEngine:
    """3가지 레이어를 모두 활용하는 앙상블"""
    
    def analyze(self, market):
        # Layer 1: Hybrid
        tech_signal, tech_conf = hybrid_engine.analyze(market, df)
        
        # Layer 2: Multi-TF
        trend_signal, trend_conf = multi_tf_engine.analyze(market)
        
        # Layer 3: RL (선택적)
        if use_rl:
            rl_action, rl_conf = rl_agent.predict(state)
        
        # 가중치 투표
        final_action, final_conf = combine_signals(
            tech_signal, tech_conf, weight=0.3,
            trend_signal, trend_conf, weight=0.3,
            rl_action, rl_conf, weight=0.4
        )
        
        return final_action, final_conf
```

### 4.2 신호 조합 규칙

| 상황 | Layer 1 | Layer 2 | Layer 3 | 최종 판단 | 신뢰도 |
|------|---------|---------|---------|-----------|--------|
| 완벽한 일치 | BUY | BUY | BUY | **BUY** | **95%** |
| 2/3 일치 | BUY | BUY | HOLD | **BUY** | **80%** |
| 강한 신호 1개 | BUY (85%) | HOLD | HOLD | **BUY** | **65%** |
| 신호 충돌 | BUY | SELL | - | **HOLD** | **40%** |
| 하락 트렌드 | - | DOWN | - | **HOLD** | **20%** |

---

## 5. 데이터 수집 전략

### 5.1 멀티 타임프레임 데이터

```python
# backend/scripts/collect_data.py

timeframes = [
    ("minute5", 288 * 7),    # 5분봉: 7일치
    ("minute15", 96 * 14),   # 15분봉: 14일치
    ("minute60", 24 * 90),   # 1시간봉: 90일치
    ("day", 365),            # 일봉: 1년치
]

for market in ["KRW-BTC", "KRW-ETH", "KRW-XRP", "KRW-SOL"]:
    for interval, count in timeframes:
        data = collect_ohlcv(market, interval, count)
        save_data(f"{market}_{interval}.csv", data)
```

### 5.2 저장 구조

```
backend/data/raw/
├── KRW_BTC_minute5.csv      # 5분봉 (7일)
├── KRW_BTC_minute15.csv     # 15분봉 (14일)
├── KRW_BTC_minute60.csv     # 1시간봉 (90일)
├── KRW_BTC_day.csv          # 일봉 (1년)
├── KRW_ETH_minute5.csv
├── ... (동일 구조)
```

---

## 6. 시스템 구성도 (v4.0)

```
[사용자 브라우저]
      │
      ▼
[웹앱 (Frontend: React)]
      │
      ▼
[API 서버 (FastAPI)]
      │
      ├── [Enhanced Trading Engine] ★NEW
      │       ├─ Layer 1: Hybrid Engine
      │       ├─ Layer 2: Multi-Timeframe
      │       └─ Layer 3: RL Agent (Optional)
      │
      ├── [기존 ML Predictor] (보조)
      │       ├─ LSTM + LightGBM
      │       └─ 자동 재훈련 (매일 3AM)
      │
      ├── [신호 필터링 v3.0]
      │       ├─ 연속 신호 차단
      │       └─ 고신뢰도 신호만 통과
      │
      ├── [Emergency Guard]
      │       └─ 급락 감지 즉시 매도
      │
      └── [업비트 API 통신]
              ├─ 1분 주기 거래 (기존 5분)
              └─ 실시간 시세 조회
```

---

## 7. 거래 파라미터 (v4.0)

### 7.1 워뇨띠 스타일 적용

| 파라미터 | v3.0 (기존) | v4.0 (개선) | 변경 사유 |
|----------|-------------|-------------|-----------|
| 거래 주기 | 5분 | **1분** | 5배 더 많은 기회 |
| 손절 라인 | -3% | **-2%** | 빠른 손절 |
| 익절 라인 | +5% | **+2%** | 소액 다회 |
| 투자 비율 | 10% | **5-15%** | 신뢰도 기반 |
| 최대 보유 | 무제한 | **30분** | 장기 보유 금지 |

### 7.2 신뢰도별 투자 비율

```python
if confidence >= 0.80:
    investment_ratio = 0.15  # 15% (매우 높음)
elif confidence >= 0.70:
    investment_ratio = 0.10  # 10% (높음)
elif confidence >= 0.60:
    investment_ratio = 0.07  # 7% (보통)
else:
    investment_ratio = 0.05  # 5% (낮음)
```

---

## 8. 성능 비교

### 8.1 시스템 버전별 성능

| 버전 | 전략 | 반응속도 | 수익률 (주간) | 상태 |
|------|------|----------|--------------|------|
| v1.0 | ML 단독 | 5분 | -5% ~ +3% | ❌ 폐기 |
| v2.0 | ML + Emergency | 5분 | -2% ~ +5% | ❌ 개선 필요 |
| v3.0 | ML + Filter | 5분 | -7.3% (실측) | ❌ 실패 |
| **v4.0** | **3-Layer 통합** | **1분** | **+10-15% (예상)** | ✅ **현재** |

### 8.2 레이어별 성능 (예상)

| 구성 | 사용 레이어 | 예상 수익률 | 구현 시간 |
|------|-------------|------------|----------|
| Phase 1 | Layer 1 + 2 | **+10-15%** | **3시간** ✅ |
| Phase 2 | Layer 1 + 2 + 3 | **+15-20%** | 1-2주 |

---

## 9. 구현 로드맵

### 9.1 Phase 1: 즉시 적용 (완료)

#### ✅ 2024-12-06 구현 완료
```bash
# Layer 1: Hybrid Engine
backend/app/trading/hybrid_engine.py ✅

# Layer 2: Multi-Timeframe Engine
backend/app/trading/multi_timeframe_engine.py ✅

# Enhanced Engine (통합)
backend/app/trading/enhanced_engine.py ✅

# 데이터 수집 개선
backend/scripts/collect_data.py ✅

# 거래 주기 단축
.env: TRADING_CYCLE_SECONDS=60 ✅
```

#### 🔄 배포 절차 (진행 중)
```bash
# 1. 멀티 타임프레임 데이터 수집
docker compose exec backend python /app/scripts/collect_data.py

# 2. 서비스 재시작
docker compose restart worker scheduler

# 3. 로그 모니터링
docker compose logs -f worker | grep "Enhanced"
```

---

### 9.2 Phase 2: 강화학습 추가 (향후)

#### Week 1-2: RL 환경 구축
```python
# backend/app/ml/rl_agent.py
- DQN 또는 PPO 에이전트 구현
- 거래 환경 정의 (OpenAI Gym)
- 보상 함수 설계
```

#### Week 3-4: 학습 및 검증
```bash
# 과거 데이터로 학습
python scripts/train_rl_agent.py --episodes 10000

# 백테스트
python scripts/backtest_rl.py --period 90d

# 실전 배포
# FullIntegratedEngine 활성화
```

---

## 10. 모니터링 지표

### 10.1 일일 체크리스트

```
□ 자동 재훈련 실행 (매일 3AM)
  - docker compose logs scheduler | grep "auto-model-retrain"

□ Enhanced Engine 신호 확인
  - docker compose logs worker | grep "Enhanced"

□ 거래 횟수
  - 기대: 5-15회/일 (1분 주기)
  - 기존: 1-2회/주 (5분 주기)

□ 평균 신뢰도
  - 목표: 60% 이상
  - 기존: 10-30%

□ 일일 수익률
  - 목표: +1-3%
  - 기존: -1% ~ +0.5%
```

### 10.2 주간 리포트

```
일주일 누적 지표:
- 총 거래 횟수: __회
- 승률: __%
- 누적 수익률: __%
- 최대 낙폭: __%
- Sharpe Ratio: __
```

---

## 11. 리스크 관리 (v4.0 강화)

### 11.1 다층 방어 시스템

```
1단계: 신호 필터링 v3.0
- 연속 신호 차단
- 신뢰도 임계값 (60%)

2단계: Enhanced Engine
- 3개 레이어 교차 검증
- 신호 충돌 시 HOLD

3단계: Emergency Guard
- 급락 5% 즉시 매도
- 변동성 필터

4단계: 손절/익절
- 손절: -2%
- 익절: +2%
- 최대 보유: 30분
```

### 11.2 일일 손실 한도

```python
# backend/app/core/config.py

class Settings:
    max_daily_loss: float = 0.05  # 5%
    max_loss_per_trade: float = 0.02  # 2%
    max_open_positions: int = 3
    max_holding_minutes: int = 30
```

---

## 12. 기대 효과

### 12.1 정량적 개선

| 지표 | v3.0 (기존) | v4.0 (예상) | 개선율 |
|------|-------------|-------------|--------|
| 주간 수익률 | -7.3% | **+10-15%** | **+240%** |
| 거래 횟수/주 | 1-2회 | **35-105회** | **+50배** |
| 평균 신뢰도 | 10-30% | **60-80%** | **+200%** |
| 반응 속도 | 5분 | **1분** | **5배** |
| 승률 | 40% | **65-75%** | **+60%** |

### 12.2 정성적 개선

```
✅ 워뇨띠 스타일 부합
- 1분 주기 빠른 반응
- 소액 분산 다회 거래
- 빠른 손절/익절

✅ 감정 배제
- 기계적 판단
- 일관된 전략 적용

✅ 24시간 자동 운영
- 인간 불가능한 속도
- 밤낮 없는 감시

✅ 지속적 학습
- 매일 3AM 자동 재훈련
- 최신 패턴 반영
```

---

## 13. 결론

### 13.1 v4.0의 핵심 혁신

```
🎯 문제 해결:
- 데이터 주기 불일치 → 1분 주기 + 멀티 타임프레임
- ML 과신 → 3-Layer 앙상블
- 느린 반응 → 기술적 지표 (1초)

🚀 성능 목표:
- 주간 수익률: +10-15%
- 승률: 65-75%
- 거래 횟수: 35-105회/주

⚡ 즉시 적용:
- Phase 1 완료 (2024-12-06)
- 배포 대기 중
```

### 13.2 다음 단계

```
단기 (1주):
□ Phase 1 실전 검증
□ 성능 모니터링
□ 파라미터 튜닝

중기 (1개월):
□ A/B 테스트 (v3 vs v4)
□ 데이터 분석 리포트
□ 전략 최적화

장기 (3개월):
□ Phase 2 (RL) 도입
□ 자동 하이퍼파라미터 튜닝
□ 멀티 마켓 확장
```

---

**작성일**: 2024-12-06  
**버전**: 4.0  
**작성자**: GitHub Copilot  
**상태**: 구현 완료, 배포 대기

**다음 리뷰**: 2024-12-13 (실전 1주 결과 분석)

---

## 14. 알림 및 경보 시스템 (Notification System)

### 14.1 개요
사용자가 별도의 앱 설치 없이 무료로 쉽게 알림을 받을 수 있도록 **Telegram**과 **Email**을 지원합니다. 또한 불필요한 알림 공해를 방지하기 위해 **알림 수위(Alert Level)**를 설정하여 중요한 문제 발생 시에만 알림을 받을 수 있도록 합니다.

### 14.2 지원 채널
1.  **Telegram (권장)**
    *   **장점**: 무료, 즉시성, 별도 앱 개발 불필요 (Telegram 메신저 사용).
    *   **설정**: BotFather를 통해 봇 생성 후 Token 및 Chat ID 입력.
2.  **Email (SMTP)**
    *   **장점**: 무료 (Gmail 등 사용), 기록 보관 용이.
    *   **설정**: SMTP 서버 정보 (Host, Port, User, Password) 입력.

### 14.3 알림 수위 (Alert Level)
알림의 중요도에 따라 발송 여부를 결정합니다. 기본값은 **WARNING**입니다.

| 레벨 | 설명 | 예시 | 기본 발송 여부 |
| :--- | :--- | :--- | :--- |
| **INFO** | 일반적인 정보 | 매매 체결, 일일 리포트(정상), 시스템 시작 | ❌ (설정 시 가능) |
| **WARNING** | 주의가 필요한 상황 | 손절 매도, API 지연, 데이터 수집 실패 | ✅ |
| **ERROR** | 즉각 조치가 필요한 장애 | 주문 실패, 잔고 부족, 시스템 크래시 | ✅ |

### 14.4 구현 계획
*   **설정 관리**: `.env` 파일에 채널별 설정 및 `ALERT_LEVEL` 추가.
*   **서비스 로직**: `Notifier` 클래스에서 레벨 필터링 및 다중 채널 발송 처리.
*   **헬스 체크**: 일일 리포트 전송 시 `INFO` 레벨이라도 강제 전송 옵션 지원 (사용자가 원할 경우).

### 14.5 설정 예시 (.env)
```env
# 알림 설정
ALERT_LEVEL=WARNING  # INFO, WARNING, ERROR

# Telegram
TELEGRAM_BOT_TOKEN=123456789:ABCdefGHIjklMNOpqrsTUVwxyz
TELEGRAM_CHAT_ID=987654321

# Email
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_USER=your_email@gmail.com
EMAIL_PASSWORD=your_app_password
```
