# 트레이딩 시스템 긴급 수정 보고서 (2025-12-10)

## 1. 문제 상황 분석
사용자로부터 "가상화폐 시장이 상승장임에도 불구하고 수익률이 마이너스인 현상"에 대한 리포트를 접수했습니다. 시스템 로그와 데이터베이스 상태를 분석한 결과, 다음과 같은 핵심 원인이 식별되었습니다.

### 1.1. 데이터 동기화 지연 (Critical)
- **현상**: `MultiTimeframeEngine`이 실시간 API 데이터가 아닌, 과거에 수집된 CSV 파일(`data/raw/*`)을 읽어서 분석하고 있었습니다.
- **원인**: 백엔드 컨테이너 내에서 파일 시스템 업데이트가 실시간으로 반영되지 않거나, 수집 스크립트와 분석 엔진 간의 시차 발생.
- **영향**: 이미 지나간 과거의 상승/하락 패턴을 현재 시점으로 착각하여 잘못된 매매 신호(뒷북 매매)를 생성.

### 1.2. 포지션 추적 누락 (Critical)
- **현상**: 매수 주문이 체결되어도 데이터베이스의 `trade_positions` 테이블에 기록되지 않음.
- **원인**: `TradeExecutor` 클래스 내에 매수 성공 시 DB에 레코드를 생성하는 로직이 구현되어 있지 않음.
- **영향**:
  - 시스템이 현재 어떤 코인을 얼마에 샀는지 모름.
  - 목표가(Take Profit) 및 손절가(Stop Loss) 로직이 작동 불가능.
  - 매도 시점 판단 불가로 인한 비효율적 보유 또는 손실 확대.

### 1.3. 잔고 불일치
- **현상**: 실제 Upbit 계좌에는 BTC, ETH 등을 보유 중이나, 시스템 DB에는 '보유 없음'으로 인식.
- **영향**: 중복 매수 시도(잔고 부족으로 실패) 또는 매도 기회 상실.

---

## 2. 수정 조치 사항

### 2.1. 실시간 데이터 분석 체계 구축
- **수정 파일**: `backend/app/trading/multi_timeframe_engine.py`
- **내용**:
  - 파일 로드 방식(`pd.read_csv`)을 제거.
  - `pyupbit.get_ohlcv()` 함수를 사용하여 Upbit API로부터 직접 실시간 캔들 데이터를 조회하도록 변경.
  - 1시간봉, 15분봉, 5분봉 데이터를 즉시 가져와 분석하므로 시차 문제 해결.

### 2.2. 매매 실행 및 포지션 관리 로직 보강
- **수정 파일**: `backend/app/trading/engine.py`
- **내용**:
  - **매수(BUY)**: 주문 성공(`uuid` 확인) 시 `TradePosition` 레코드를 생성.
    - 진입가(`entry_price`): 체결 당시 현재가
    - 손절가(`stop_loss`): -3% 설정
    - 목표가(`take_profit`): +5% 설정
  - **매도(SELL)**: 주문 성공 시 해당 마켓의 `OPEN` 상태인 포지션을 찾아 `CLOSED`로 상태 변경.

### 2.3. 포지션 동기화 도구 개발
- **신규 파일**: `backend/scripts/sync_positions.py`
- **내용**:
  - Upbit 계좌의 실제 잔고를 조회.
  - DB에 없는 포지션은 자동으로 추가(INSERT).
  - DB에는 있는데 실제로는 없는 포지션은 종료 처리(UPDATE).
  - **실행 결과**: 기존에 누락되었던 BTC, ETH 포지션이 정상적으로 DB에 복구됨.

---

## 3. 검증 결과

### 3.1. 데이터 분석 테스트
- `MultiTimeframeEngine` 직접 실행 테스트 결과, 현재 시장가(BTC 1.38억 등)를 정확히 반영하여 분석 결과 도출 확인.
- 로그: `Action: BUY, Conf: 0.7 ... latest_prices: {'1h': 138700000.0 ...}`

### 3.2. 포지션 동기화
- 스크립트 실행 후 DB 조회 결과:
  - `KRW-BTC`: 진입가 약 1.37억 원, 상태 OPEN
  - `KRW-ETH`: 진입가 약 494만 원, 상태 OPEN
- 실제 Upbit 잔고와 일치 확인.

### 3.3. 매매 로직
- 로그 확인 결과 `TradeExecutor`가 매수 시도 후 잔고 부족(`UnderMinTotalBid`)으로 실패하는 것을 확인.
- 이는 로직이 정상 동작하여 주문을 시도했음을 의미하며, 현재 대부분의 자산이 이미 코인에 투자되어 있어 추가 매수가 불가능한 정상적인 상태임.

---

## 4. 향후 운영 가이드

1. **모니터링**: `daily_health_check.py`가 2시간마다 실행되며 시스템 상태를 점검합니다.
2. **포지션 수동 동기화**: 만약 Upbit 앱에서 수동으로 매매를 했다면, 반드시 `docker compose exec backend python /app/scripts/sync_positions.py`를 실행하여 시스템 DB와 동기화해 주어야 합니다.
3. **자금 관리**: 현재 자산의 대부분이 투자된 상태이므로, 추가 매수를 원할 경우 입금이 필요하거나 기존 포지션이 익절/손절되어 현금화될 때까지 기다려야 합니다.
