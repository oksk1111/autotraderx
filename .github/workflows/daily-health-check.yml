name: Daily Health Check

on:
  schedule:
    # 매일 오전 9시 (KST 기준, UTC는 00:00)
    - cron: '0 0 * * *'
  workflow_dispatch:  # 수동 실행 가능

jobs:
  health-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Run health check via SSH
        uses: appleboy/ssh-action@master
        env:
            GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
            SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ubuntu
          key: ${{ secrets.ORACLE_SSH_KEY }}
          port: 22
          script: |
            cd /home/ubuntu/autotraderx
            # Backend 컨테이너 내부에서 헬스 체크 스크립트 실행
            docker compose exec -T backend python /app/scripts/daily_health_check.py
      
      - name: Send notification on failure
        if: failure()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
            if [ -n "$SLACK_WEBHOOK_URL" ]; then
                curl -X POST $SLACK_WEBHOOK_URL \
                -H 'Content-Type: application/json' \
                -d '{"text":"❌ Daily Health Check Failed! Please check the logs."}'
            fi
