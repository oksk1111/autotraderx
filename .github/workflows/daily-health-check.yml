name: Daily Health Check

on:
  schedule:
    # 매일 오전 9시 (KST 기준, UTC는 00:00)
    - cron: '0 0 * * *'
  workflow_dispatch:  # 수동 실행 가능

jobs:
  health-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Run health check via SSH
        uses: appleboy/ssh-action@master
        env:
            GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
            SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        with:
          envs: GROQ_API_KEY
          host: ${{ secrets.SERVER_HOST }}
          username: ubuntu
          key: ${{ secrets.ORACLE_SSH_KEY }}
          port: 22
          script: |
            cd /home/ubuntu/autotraderx/backend
            source venv/bin/activate
            # Run health check script directly
            export PYTHONPATH=$PYTHONPATH:$(pwd)
            python scripts/daily_health_check.py
      
      - name: Send notification on failure
        if: failure()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
            if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
                curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
                -d "chat_id=${TELEGRAM_CHAT_ID}" \
                -d "text=❌ Daily Health Check Failed! Please check the logs."
            fi
