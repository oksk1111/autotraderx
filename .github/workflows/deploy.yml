name: Deploy to Cloud

on:
  push:
    branches:
      - master
      - main
  workflow_dispatch:  # 수동 실행 가능

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy to Oracle Cloud
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ubuntu
          key: ${{ secrets.ORACLE_SSH_KEY }}
          port: 22
          script: |
            cd /home/ubuntu/autotraderx
            
            echo "=== 최신 코드 Pull ==="
            git fetch origin
            # 현재 브랜치 확인 후 reset
            git reset --hard origin/master || git reset --hard origin/main
            
            echo "=== Docker Compose 재빌드 및 실행 ==="
            # 불필요한 이미지 정리
            docker image prune -f
            
            # 서비스 재시작
            docker compose down
            docker compose up -d --build
            
            echo "=== 배포 완료 ==="
            docker compose ps

      - name: Health Check
        run: |
          echo "Waiting for services to start..."
          sleep 60  # 서비스 시작 대기 시간 증가
          
          SERVER_HOST=${{ secrets.SERVER_HOST }}
          
          # 백엔드 헬스 체크
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 http://$SERVER_HOST:8000/health || echo "000")
          
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "✅ Backend health check passed"
          else
            echo "⚠️ Backend health check returned: $HTTP_STATUS"
            exit 1
          fi
          
          # 프론트엔드 체크
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 http://$SERVER_HOST:4173 || echo "000")
          
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "✅ Frontend health check passed"
          else
            echo "⚠️ Frontend health check returned: $HTTP_STATUS"
          fi
      
      - name: Send notification on failure
        if: failure()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # Telegram 알림
          if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d "chat_id=${TELEGRAM_CHAT_ID}" \
              -d "text=❌ AutoTraderX 배포 실패! GitHub Actions 로그를 확인하세요."
          fi
      
      - name: Send success notification
        if: success()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # Telegram 성공 알림
          if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d "chat_id=${TELEGRAM_CHAT_ID}" \
              -d "text=✅ AutoTraderX 배포 완료! 정상적으로 서비스가 시작되었습니다."
          fi
