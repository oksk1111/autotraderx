name: Deploy to Cloud

on:
  push:
    branches:
      - master
      - main
  workflow_dispatch:  # 수동 실행 가능

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ubuntu
          key: ${{ secrets.ORACLE_SSH_KEY }}
          port: 22
          script_stop: true
          command_timeout: 20m
          script: |
            # 1. 작업 디렉토리 확인 및 생성
            TARGET_DIR="/home/ubuntu/autotraderx"
            # 디렉토리가 없거나, 디렉토리인데 .git이 없으면 (잘못된 상태) 재설정
            if [ ! -d "$TARGET_DIR/.git" ]; then
              echo "Git repository not found or corrupted. Re-cloning..."
              # sudo를 사용하여 권한 문제 회피
              sudo rm -rf "$TARGET_DIR"
              git clone https://github.com/oksk1111/autotraderx.git "$TARGET_DIR"
            fi

            cd "$TARGET_DIR"

            # 2. 코드 최신화 (master 또는 main 브랜치 탐지)
            echo "Fetching changes..."
            git fetch origin
            
            # 원격 브랜치 확인
            if git show-ref --verify --quiet refs/remotes/origin/master; then
               BRANCH="master"
            else
               BRANCH="main"
            fi
            
            echo "Deploying branch: $BRANCH"
            git reset --hard origin/$BRANCH

            # 3. Docker Compose 실행 (v2 또는 v1 감지)
            DOCKER_CMD="docker"
            if ! groups | grep -q "docker"; then
               DOCKER_CMD="sudo docker"
            fi
            
            # docker compose (v2) vs docker-compose (v1) 확인
            if $DOCKER_CMD compose version >/dev/null 2>&1; then
               COMPOSE_CMD="$DOCKER_CMD compose"
            elif command -v docker-compose >/dev/null 2>&1; then
               # docker-compose는 보통 sudo 없이 실행하거나 별도 권한 필요
               # 여기서는 sudo로 통일 시도
               if ! groups | grep -q "docker"; then
                   COMPOSE_CMD="sudo docker-compose"
               else
                   COMPOSE_CMD="docker-compose"
               fi
            else
               echo "Error: docker compose or docker-compose not found"
               exit 1
            fi

            echo "Using compose command: $COMPOSE_CMD"
            
            # 서비스 재시작
            $COMPOSE_CMD down
            $COMPOSE_CMD up -d --build
            
            # 4. 불필요한 이미지 정리
            $DOCKER_CMD image prune -f

      - name: Health Check
        run: |
          echo "Waiting for services to start..."
          sleep 60  # 서비스 시작 대기 시간
          
          SERVER_HOST=${{ secrets.SERVER_HOST }}
          
          # 백엔드 체크
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 http://$SERVER_HOST:8000/health || echo "000")
          if [ "$HTTP_STATUS" != "200" ]; then
             echo "⚠️ Backend health check failed: $HTTP_STATUS"
             # 배포 스크립트 실패 처리를 위해 exit 1 (선택)
             exit 1
          else
             echo "✅ Backend health check passed"
          fi
          
          # 프론트엔드 체크
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 http://$SERVER_HOST:4173 || echo "000")
          if [ "$HTTP_STATUS" != "200" ]; then
             echo "⚠️ Frontend health check failed: $HTTP_STATUS"
          else
             echo "✅ Frontend health check passed"
          fi
      
      - name: Send Notification
        if: always()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          STATUS: ${{ job.status }}
        run: |
          if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
            if [ "$STATUS" == "success" ]; then
               MSG="✅ AutoTraderX 배포 성공!"
            else
               MSG="❌ AutoTraderX 배포 실패! GitHub 로그를 확인하세요."
            fi
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d "chat_id=${TELEGRAM_CHAT_ID}" \
              -d "text=$MSG"
          fi
