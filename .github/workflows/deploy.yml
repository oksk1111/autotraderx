name: Deploy to Cloud

on:
  push:
    branches:
      - master
      - main
  workflow_dispatch:  # 수동 실행 가능

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ubuntu
          key: ${{ secrets.ORACLE_SSH_KEY }}
          port: 22
          command_timeout: 40m  # 타임아웃 20분 -> 40분으로 증가
          script: |
            set -e  # 오류 발생 시 즉시 중단
            # 1. 작업 디렉토리 확인 및 생성
            TARGET_DIR="/home/ubuntu/autotraderx"
            # 디렉토리가 없거나, 디렉토리인데 .git이 없으면 (잘못된 상태) 재설정
            if [ ! -d "$TARGET_DIR/.git" ]; then
              echo "Git repository not found or corrupted. Re-cloning..."
              # sudo를 사용하여 권한 문제 회피
              sudo rm -rf "$TARGET_DIR"
              git clone https://github.com/oksk1111/autotraderx.git "$TARGET_DIR"
            fi

            cd "$TARGET_DIR"

            # 2. 코드 최신화 (master 또는 main 브랜치 탐지)
            echo "Fetching changes..."
            git fetch origin
            
            # 원격 브랜치 확인
            if git show-ref --verify --quiet refs/remotes/origin/master; then
               BRANCH="master"
            else
               BRANCH="main"
            fi
            
            echo "Deploying branch: $BRANCH"
            git reset --hard origin/$BRANCH

            # 3. 변경 사항 반영 (No Docker / Systemd 방식)
            echo "=== Starting 'No Docker' Deployment ==="

            # 3-1. Backend 의존성 업데이트
            if [ -f "backend/requirements.txt" ]; then
              echo "Updating backend dependencies..."
              cd backend
              # venv가 있다면 활성화, 없으면 생성 (안전장치)
              if [ ! -d "venv" ]; then
                python3 -m venv venv
              fi
              source venv/bin/activate
              pip install -r requirements.txt
              deactivate
              cd ..
            fi

            # 3-2. Frontend 빌드 (package.json 있는 경우)
            if [ -f "frontend/package.json" ]; then
              echo "Building frontend..."
              
              # NVM 로드 (Non-interactive shell 지원)
              export NVM_DIR="$HOME/.nvm"
              if [ -s "$NVM_DIR/nvm.sh" ]; then
                . "$NVM_DIR/nvm.sh"
              elif [ -s "/usr/local/nvm/nvm.sh" ]; then
                . "/usr/local/nvm/nvm.sh"
              else
                echo "Warning: NVM not found. Assuming node is in PATH."
              fi
              
              # Node 버전 확인
              node -v || echo "Node not found"
              npm -v || echo "NPM not found"
              
              cd frontend
              # npm install은 시간이 걸리므로 필요시 최적화 가능
              npm install --legacy-peer-deps
              npm run build
              cd ..
            fi
            
            # 3-3. Systemd 서비스 재시작
            echo "Restarting Systemd services..."
            # sudo 권한 필요 (NOPASSWD 설정되어 있다고 가정)
            sudo systemctl restart autotrader-backend
            sudo systemctl restart autotrader-worker
            sudo systemctl restart autotrader-scheduler
            sudo systemctl restart autotrader-frontend

            # 4. 서비스 상태 확인
            echo "Checking status..."
            sleep 5
            sudo systemctl status autotrader-backend --no-pager
            sudo systemctl is-active autotrader-backend
            
            echo "=== Deployment Completed ==="

      - name: Health Check via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ubuntu
          key: ${{ secrets.ORACLE_SSH_KEY }}
          port: 22
          script: |
            echo "=== Health Check Started ==="
            # Retry loop: 18 attempts * 10s = 3 minutes max wait
            MAX_RETRIES=18
            # Use 127.0.0.1 to avoid IPv6 issues with localhost
            # Add trailing slash to avoid 307 Redirect
            BACKEND_URL="http://127.0.0.1:8000/api/health/"
            FRONTEND_URL="http://127.0.0.1:4173"
            
            check_service() {
              local url=$1
              local name=$2
              local success=0
              
              for i in $(seq 1 $MAX_RETRIES); do
                HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$url" || echo "000")
                if [ "$HTTP_STATUS" = "200" ]; then
                  echo "✅ $name is UP! (Status: 200)"
                  success=1
                  break
                fi
                echo "⏳ Waiting for $name... ($i/$MAX_RETRIES) - Current: $HTTP_STATUS"
                sleep 10
              done
              
              if [ $success -eq 0 ]; then
                echo "❌ $name failed to respond after $((MAX_RETRIES*10)) seconds."
                return 1
              fi
              return 0
            }

            # Check Backend
            if ! check_service "$BACKEND_URL" "Backend"; then
               echo "--- Backend Logs ---"
               cd /home/ubuntu/autotraderx
               # Docker command detection again for logs
               DOCKER_CMD="docker"
               if ! groups | grep -q "docker"; then DOCKER_CMD="sudo docker"; fi
               $DOCKER_CMD compose logs --tail=50 backend
               exit 1
            fi
            
            # Check Frontend
            # Frontend might return 200 or 304, usually 200 for root
            if ! check_service "$FRONTEND_URL" "Frontend"; then
               echo "--- Frontend Logs ---"
               cd /home/ubuntu/autotraderx
               DOCKER_CMD="docker"
               if ! groups | grep -q "docker"; then DOCKER_CMD="sudo docker"; fi
               $DOCKER_CMD compose logs --tail=50 frontend
               exit 1
            fi
            
            echo "=== All Services Healthy ==="
      
      - name: Send Notification
        if: always()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          STATUS: ${{ job.status }}
        run: |
          if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
            if [ "$STATUS" == "success" ]; then
               MSG="✅ AutoTraderX 배포 성공!"
            else
               MSG="❌ AutoTraderX 배포 실패! GitHub 로그를 확인하세요."
            fi
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d "chat_id=${TELEGRAM_CHAT_ID}" \
              -d "text=$MSG"
          fi
